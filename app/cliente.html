<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ Cat√°logo de Filmes - Sistema de Cinema</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="fade-in">
<div class="container">
    <div class="navigation-buttons">
        <h1 class="page-title" data-page="cliente">üé≠ Cat√°logo de Filmes</h1>
        <button onclick="logout()" class="nav-btn logout">Sair do Sistema</button>
    </div>

    <div class="welcome-message">
        <h2>üéâ Bem-vindo ao nosso cat√°logo!</h2>
        <p>Confira abaixo todos os filmes dispon√≠veis em nossa programa√ß√£o.</p>
    </div>

    <div class="catalogo" id="catalogo">
        <!-- Os cards de filmes ser√£o carregados aqui -->
    </div>
</div>

<!-- Modal de Compra de Ingressos -->
<div id="modalIngresso" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitulo">üé´ Comprar Ingresso</h2>
            <button class="close-modal" onclick="fecharModalIngresso()">&times;</button>
        </div>

        <div class="modal-body">
            <div class="filme-info" id="filmeInfo">
                <img id="modalCartaz" src="" alt="Cartaz do Filme">
                <div class="filme-detalhes">
                    <h3 id="modalFilmeTitulo"></h3>
                    <p id="modalFilmeGenero"></p>
                    <p id="modalFilmeDuracao"></p>
                    <p id="modalFilmeClassificacao"></p>
                </div>
            </div>

            <div class="sessao-selecao">
                <h4>üìÖ Selecione a Sess√£o</h4>
                <div id="listaSessoes" class="lista-sessoes"></div>
            </div>

            <div class="quantidade-ingressos">
                <h4>üéüÔ∏è Quantidade de Ingressos</h4>
                <div class="quantidade-controls">
                    <button class="qtd-btn" onclick="alterarQuantidade(-1)">-</button>
                    <span id="quantidade" class="quantidade">1</span>
                    <button class="qtd-btn" onclick="alterarQuantidade(1)">+</button>
                </div>
                <p class="preco-total">Total: <span id="precoTotal">R$ 0,00</span></p>
            </div>

            <div class="resumo-compra">
                <h4>üìã Resumo da Compra</h4>
                <div id="resumoCompra" class="resumo-detalhes"></div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" onclick="fecharModalIngresso()">Cancelar</button>
            <button class="btn-primary" onclick="finalizarCompra()">Finalizar Compra</button>
        </div>
    </div>
</div>

<script src="script.js"></script>

<!-- C√ìDIGO ESPEC√çFICO PARA A P√ÅGINA DO CLIENTE -->
<script>
    // Vari√°veis globais para controle do modal
    let filmeSelecionado = null;
    let sessaoSelecionada = null;
    let quantidadeIngressos = 1;
    let sessoesDisponiveis = [];

    // Fun√ß√£o principal que carrega o cat√°logo
    function carregarCatalogoCliente() {
        console.log("üé¨ Iniciando carregamento do cat√°logo...");

        const movies = JSON.parse(localStorage.getItem("movies")) || [];
        const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
        const catalogo = document.getElementById("catalogo");

        if (!catalogo) {
            console.log("‚ùå Elemento catalogo n√£o encontrado");
            return;
        }

        catalogo.innerHTML = "";

        if (movies.length === 0) {
            catalogo.innerHTML = `
                <div class="empty-state">
                    <h3>üé≠ Nenhum filme dispon√≠vel</h3>
                    <p>Volte mais tarde para conferir nossa programa√ß√£o!</p>
                </div>
            `;
            return;
        }

        console.log(`‚úÖ Carregando ${movies.length} filmes...`);

        movies.forEach(movie => {
            const sessoesFilme = sessoes.filter(sessao =>
                sessao.filme === movie.titulo && sessao.status === 'aguardando'
            );

            const card = document.createElement("div");
            card.className = "filme-card";

            // Imagem placeholder segura
            const cartazSrc = movie.cartaz && movie.cartaz.trim() !== '' ?
                movie.cartaz : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiMzMzMzMzMiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiI+U2VtIEltYWdlbTwvdGV4dD48L3N2Zz4=';

            card.innerHTML = `
                <img src="${cartazSrc}" alt="${movie.titulo}" class="filme-cartaz" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiMzMzMzMzMiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiI+U2VtIEltYWdlbTwvdGV4dD48L3N2Zz4='">
                <h3>${movie.titulo || "Sem t√≠tulo"}</h3>
                <p><strong>üè∑Ô∏è G√™nero:</strong> ${movie.genero || "N√£o informado"}</p>
                <p><strong>‚è±Ô∏è Dura√ß√£o:</strong> ${movie.duracao || "N√£o informada"} min</p>
                <p><strong>üìä Classifica√ß√£o:</strong> ${movie.classificacao || "L"}</p>
                <p><strong>üìà Status:</strong> ${movie.status || "Em Breve"}</p>
                <p class="sinopse">${movie.sinopse || "Sinopse n√£o dispon√≠vel"}</p>
                <div class="sessoes-info">
                    <p><strong>üé≠ Sess√µes dispon√≠veis:</strong> ${sessoesFilme.length}</p>
                </div>
                ${sessoesFilme.length > 0 ?
                `<button class="btn-comprar" onclick="abrirModalIngresso('${movie.titulo.replace(/'/g, "\\'")}')">
                         üé´ Comprar Ingresso
                     </button>` :
                '<p class="sem-sessoes">‚è≥ Aguardando novas sess√µes</p>'
            }
            `;
            catalogo.appendChild(card);
        });

        console.log("‚úÖ Cat√°logo carregado com sucesso!");
    }

    // Fun√ß√µes do Modal
    window.abrirModalIngresso = function (tituloFilme) {
        const movies = JSON.parse(localStorage.getItem("movies")) || [];
        const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];

        filmeSelecionado = movies.find(movie => movie.titulo === tituloFilme);
        if (!filmeSelecionado) return;

        sessoesDisponiveis = sessoes.filter(sessao =>
            sessao.filme === tituloFilme && sessao.status === 'aguardando'
        );

        document.getElementById('modalFilmeTitulo').textContent = filmeSelecionado.titulo;
        document.getElementById('modalFilmeGenero').textContent = `G√™nero: ${filmeSelecionado.genero}`;
        document.getElementById('modalFilmeDuracao').textContent = `Dura√ß√£o: ${filmeSelecionado.duracao} min`;
        document.getElementById('modalFilmeClassificacao').textContent = `Classifica√ß√£o: ${filmeSelecionado.classificacao}`;

        const cartazImg = document.getElementById('modalCartaz');
        cartazImg.src = filmeSelecionado.cartaz || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiMzMzMzMzMiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiI+U2VtIEltYWdlbTwvdGV4dD48L3N2Zz4=';
        cartazImg.alt = filmeSelecionado.titulo;

        carregarListaSessoes();
        quantidadeIngressos = 1;
        atualizarQuantidade();
        atualizarResumoCompra();

        document.getElementById('modalIngresso').classList.remove('hidden');
    };

    function carregarListaSessoes() {
        const listaSessoes = document.getElementById('listaSessoes');
        listaSessoes.innerHTML = '';

        if (sessoesDisponiveis.length === 0) {
            listaSessoes.innerHTML = '<p class="sem-sessoes">Nenhuma sess√£o dispon√≠vel para este filme</p>';
            return;
        }

        sessoesDisponiveis.forEach((sessao, index) => {
            const sessaoElement = document.createElement('div');
            sessaoElement.className = `sessao-item ${sessaoSelecionada === index ? 'selecionada' : ''}`;
            sessaoElement.innerHTML = `
                <div class="sessao-info">
                    <strong>üìç ${sessao.sala}</strong>
                    <span>üìÖ ${formatarDataSessao(sessao.data)}</span>
                    <span>üïí ${sessao.horario}</span>
                    <span>üí∞ R$ ${typeof sessao.preco === 'number' ? sessao.preco.toFixed(2).replace('.', ',') : '0,00'}</span>
                </div>
            `;
            sessaoElement.onclick = () => selecionarSessao(index);
            listaSessoes.appendChild(sessaoElement);
        });
    }

    function selecionarSessao(index) {
        sessaoSelecionada = index;
        carregarListaSessoes();
        atualizarResumoCompra();
    }

    function formatarDataSessao(dataString) {
        if (!dataString) return "Data n√£o informada";
        try {
            const [ano, mes, dia] = dataString.split('-');
            return `${dia}/${mes}/${ano}`;
        } catch (error) {
            return dataString;
        }
    }

    window.alterarQuantidade = function (alteracao) {
        const novaQuantidade = quantidadeIngressos + alteracao;
        if (novaQuantidade >= 1 && novaQuantidade <= 10) {
            quantidadeIngressos = novaQuantidade;
            atualizarQuantidade();
            atualizarResumoCompra();
        }
    };

    function atualizarQuantidade() {
        document.getElementById('quantidade').textContent = quantidadeIngressos;
    }

    function atualizarResumoCompra() {
        const resumoCompra = document.getElementById('resumoCompra');
        const precoTotal = document.getElementById('precoTotal');

        if (sessaoSelecionada === null) {
            resumoCompra.innerHTML = '<p>Selecione uma sess√£o para ver o resumo</p>';
            precoTotal.textContent = 'R$ 0,00';
            return;
        }

        const sessao = sessoesDisponiveis[sessaoSelecionada];
        const preco = typeof sessao.preco === 'number' ? sessao.preco : 0;
        const total = preco * quantidadeIngressos;

        resumoCompra.innerHTML = `
            <div class="resumo-item">
                <span>Filme:</span>
                <span>${filmeSelecionado.titulo}</span>
            </div>
            <div class="resumo-item">
                <span>Sess√£o:</span>
                <span>${formatarDataSessao(sessao.data)} - ${sessao.horario || 'Hor√°rio n√£o informado'}</span>
            </div>
            <div class="resumo-item">
                <span>Sala:</span>
                <span>${sessao.sala || 'Sala n√£o informada'}</span>
            </div>
            <div class="resumo-item">
                <span>Ingressos:</span>
                <span>${quantidadeIngressos} x R$ ${preco.toFixed(2).replace('.', ',')}</span>
            </div>
        `;

        precoTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    window.fecharModalIngresso = function () {
        document.getElementById('modalIngresso').classList.add('hidden');
        filmeSelecionado = null;
        sessaoSelecionada = null;
        quantidadeIngressos = 1;
    };

    window.finalizarCompra = function () {
        if (sessaoSelecionada === null) {
            alert('Por favor, selecione uma sess√£o!');
            return;
        }

        const sessao = sessoesDisponiveis[sessaoSelecionada];
        const preco = typeof sessao.preco === 'number' ? sessao.preco : 0;
        const total = preco * quantidadeIngressos;

        const compra = {
            id: Date.now(),
            filme: filmeSelecionado.titulo,
            sessao: {...sessao, preco: preco},
            quantidade: quantidadeIngressos,
            total: total,
            dataCompra: new Date().toISOString(),
            status: 'confirmada'
        };

        const compras = JSON.parse(localStorage.getItem('compras')) || [];
        compras.push(compra);
        localStorage.setItem('compras', JSON.stringify(compras));

        alert(`üéâ Compra realizada com sucesso!\n\nFilme: ${filmeSelecionado.titulo}\nSess√£o: ${formatarDataSessao(sessao.data)} - ${sessao.horario}\nSala: ${sessao.sala}\nIngressos: ${quantidadeIngressos}\nTotal: R$ ${total.toFixed(2).replace('.', ',')}`);

        fecharModalIngresso();
        carregarCatalogoCliente();
    };

    // Inicializar a p√°gina quando carregar
    document.addEventListener('DOMContentLoaded', function () {
        console.log("üöÄ P√°gina cliente carregada!");
        carregarCatalogoCliente();
    });

    // Fallback: se o DOMContentLoaded j√° passou, executar imediatamente
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(carregarCatalogoCliente, 100);
    }
</script>
</body>
</html>